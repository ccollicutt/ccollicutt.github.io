<!DOCTYPE html>
<html lang="en" class="min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wireguard, Dante, and Firefox | Server As Code Dot Com</title>
    <meta name="description" content="A techno-blog for our techno-times">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">
    <link href="/assets/css/prism.min.css" rel="stylesheet">
    <link href="/assets/css/extra.css" rel="stylesheet">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <meta name="twitter:site" content="serverascode.com">
    <meta name="twitter:creator" content="Curtis Collicutt">
    
    
        <meta name="twitter:title" content="Wireguard, Dante, and Firefox">
        
        <meta name="twitter:description" content="I usually proxy my Firefox through to a remote server running in a public cloud.  Typically I just do that with ssh.

">
        <meta property="og:description" content="I usually proxy my Firefox through to a remote server running in a public cloud.  Typically I just do that with ssh.

" />
        
        <meta property="og:title" content="Wireguard, Dante, and Firefox" />
        <meta property="og:type" content="article" />
    
    
    
    
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://serverascode.com/img/social/posts/wireguard-danted-firefox.png">
    <meta property="og:image" content="https://serverascode.com/img/social/posts/wireguard-danted-firefox.png" />
    
    
    <meta property="og:url" content="https://serverascode.com/2020/03/01/wireguard-danted-firefox.html" />
    <meta property="og:site_name" content="Server As Code Dot Com" />
</head>
<body class="font-sans">
    <div class="magazine-container">
        <header>
            <div class="magazine-header">
                <div class="issue-number-dropdown">
                    <button class="issue-number-top dropdown-toggle">
                        ISSUE 250
                        <span class="arrow-down"></span>
                    </button>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h3>Navigation</h3>
                            <a href="/">Home</a>
                            <a href="/archive.html">Archive</a>
                            <a href="/feed.xml">RSS Feed</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Sections</h3>
                            <a href="/#latest-issues">Latest Issues</a>
                            <a href="/#tidal-series">Tidal Series</a>
                            <a href="/#connect-with-me">Connect With Me</a>
                            <a href="/#recent-posts">Recent Posts</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Connect</h3>
                            
                                
                            
                                
                                    <a href="https://tidalseries.com" target="_blank" rel="noopener noreferrer">TIDAL SERIES Newsletter</a>
                                
                            
                                
                                    <a href="https://www.linkedin.com/in/ccollicutt/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
                                
                            
                                
                                    <a href="https://taico.ca" target="_blank" rel="noopener noreferrer">TAICO - The Toronto AI and Cybersecurity Organization</a>
                                
                            
                                
                                    <a href="https://github.com/ccollicutt" target="_blank" rel="noopener noreferrer">GitHub</a>
                                
                            
                                
                                    <a href="https://huggingface.co/ccollicutt" target="_blank" rel="noopener noreferrer">Hugging Face</a>
                                
                            
                                
                            
                        </div>
                    </div>
                </div>
                <div class="magazine-info">
                    <div>Server As Code Dot Com</div>
                    <div class="underline"><a href="/archive.html">ARCHIVE</a></div>
                    <div class="underline">2024 AUGUST</div>
                    <div class="underline">¥980</div>
                </div>
            </div>
            <p class="magazine-subtitle">A techno-blog for our techno-times</p>
            <a href="/" class="logo-link">
                <img src="/img/logo/logo.png" alt="Server As Code Dot Com" class="logo-image">
            </a>
        </header>

        <div class="content-wrapper">
            <main class="flex-grow px-4 md:px-8 main-content">
                <div class="max-w-4xl mx-auto px-4 mt-8 mb-12">
    <div class="flex justify-center space-x-4">
        
        
        <a href="https://serverascode.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/author/curtis.jpg" alt="Curtis Collicutt" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">Curtis Collicutt</span>
        </a>
        
        
        
        <a href="https://tidalseries.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/tidalseries.png" alt="TIDAL SERIES Newsletter" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">TIDAL SERIES Newsletter</span>
        </a>
        
        
        
        <a href="https://www.linkedin.com/in/ccollicutt/" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/linkedin.png" alt="LinkedIn" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">LinkedIn</span>
        </a>
        
        
        
        
        
        <a href="https://github.com/ccollicutt" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/github.jpg" alt="GitHub" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">GitHub</span>
        </a>
        
        
        
        
        
        
    </div>
</div>

<article class="prose lg:prose-xl mx-auto">
    <header class="mb-8 text-center not-prose">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-2">Wireguard, Dante, and Firefox</h1>
        <p class="text-gray-600">
            <time datetime="2020-03-01T00:00:00-05:00">
                March 01, 2020
            </time>
            
        </p>
    </header>

    

    <p>I usually proxy my Firefox through to a remote server running in a public cloud.  Typically I just do that with ssh.</p>

<p>e.g. I run the below in a separate terminal and just leave it open.  (I could have used autossh, but never quite got around to it.)</p>

<pre><code>ssh -D 8888 remote-vpn
</code></pre>

<p>Then Firefox is configured to use the local proxy. Note that I set it to proxy DNS as well.</p>

<p><img src="/img/ff-proxy.jpg" alt="firefox proxy settings" /></p>

<p>It’s a bit of a weird setup, but it’s simple and I’m used to it.</p>

<h2 id="wireguard-instead-of-ssh">Wireguard Instead of ssh</h2>

<p>I’ve been using Wireguard in another situation, and decided it’s time to move from a manually setup ssh command to letting wireguard take care of it.</p>

<p>On local laptop:</p>

<pre><code># pwd
/etc/wireguard
# cat wg0.conf 
[Interface]
Address = 192.168.100.3/32
PrivateKey = &lt;redacted&gt;
ListenPort = 21842

[Peer]
PublicKey = &lt;redacted&gt;
Endpoint =&lt;redacted&gt;:&lt;redacted&gt;
AllowedIPs = 192.168.100.1/32
PersistentKeepalive = 25
</code></pre>

<p>On the remote server. Note that I’m enabling/disabling nat for the wg0 interface IP based on whether the wg0 interface is up or down.</p>

<pre><code># cat wg0.conf 
[Interface]
Address = 192.168.100.1/24
PrivateKey = &lt;redacted&gt;
ListenPort = &lt;redacted&gt;
PostUp = iptables -t nat -A POSTROUTING -s 192.168.100.1/32 -o eth0 -j MASQUERADE
PostDown = iptables -t nat -D POSTROUTING -s 192.168.100.1/32 -o eth0 -j MASQUERADE

[Peer]
PublicKey = &lt;redacted&gt;
AllowedIPs = 192.168.100.3/32
</code></pre>

<p>iptables config. OF course packets must be forwarded too.</p>

<pre><code># sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
# iptables -L -n -t nat
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  192.168.100.1        0.0.0.0/0  
</code></pre>

<p>On the laptop, enable and start wg0.</p>

<pre><code>sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0
</code></pre>

<p>And I’m now connected:</p>

<pre><code> $ sudo wg show
interface: wg0
  public key: &lt;redacted&gt;
  private key: (hidden)
  listening port: &lt;redacted&gt;

peer: &lt;redacted&gt;
  endpoint: &lt;redacted&gt;
  allowed ips: 192.168.100.1/32
  latest handshake: 1 minute, 44 seconds ago
  transfer: 149.80 MiB received, 10.38 MiB sent
  persistent keepalive: every 25 seconds
</code></pre>

<p>ssh is convenient because it can do proxying without any extra work. But that is not so with wireguard. I need a second proxy system. In this case, the easiest thing to use seemed to be dante.</p>

<p>I’ve configured danted in /etc/danted.conf. (This configuration could probably use some improvement.)</p>

<p>NOTE: Only listening on wg0. Don’t put it on the external interface.</p>

<pre><code># cat /etc/danted.conf
logoutput: /var/log/socks.log
internal: wg0 port = 1080
external: wg0
clientmethod: none
socksmethod: none
user.privileged: root
user.notprivileged: nobody

client pass {
        from: 0.0.0.0/0 to: 0.0.0.0/0
        log: error connect disconnect
}
client block {
        from: 0.0.0.0/0 to: 0.0.0.0/0
        log: connect error
}
socks pass {
        from: 0.0.0.0/0 to: 0.0.0.0/0
        log: error connect disconnect
}
socks block {
        from: 0.0.0.0/0 to: 0.0.0.0/0
        log: connect error
}
</code></pre>

<p>Configure firefox.</p>

<p>NOTE: Firefox I guess doesn’t support user/password for proxies? Very weird.</p>

<p><img src="/img/ff-proxy2.jpg" alt="firefox proxy danted" /></p>

<p>Sessions through dante. Note the “nobody” user.</p>

<pre><code># lsof -Pni :1080 | head
COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
danted    683 nobody   26u  IPv4 609554      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:56096 (ESTABLISHED)
danted    685 nobody   20u  IPv4 609980      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:56166 (ESTABLISHED)
danted    685 nobody   22u  IPv4 609961      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:56160 (ESTABLISHED)
danted    685 nobody   58u  IPv4 622465      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:57406 (ESTABLISHED)
danted  30447 nobody    9u  IPv4 575223      0t0  TCP 192.168.100.1:1080 (LISTEN)
danted  32313 nobody   12u  IPv4 619529      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:57080 (ESTABLISHED)
danted  32313 nobody   16u  IPv4 612166      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:56324 (ESTABLISHED)
danted  32313 nobody   22u  IPv4 610614      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:56212 (ESTABLISHED)
danted  32313 nobody   62u  IPv4 618755      0t0  TCP 192.168.100.1:1080-&gt;192.168.100.3:57010 (ESTABLISHED)
</code></pre>

<h2 id="conclusion">Conclusion</h2>

<p>Using ssh was definitely simpler, but I wanted to try something else, specifically wireguard. But this means 1) setting up wireguard (FYI: is an out of tree kernel module), 2) adding a proxy and 3) configuring nat. At least one valuable option in using wireguard is that I can send all traffic through wireguard if I want to. I’m not right now, but I could.</p>

<p>That said, I need to do some more work related to the proxy configuration, and whether dante is really the best option here. I’ll experiment with this setup for a while and determine if there are better options. Do I recommend this setup? I think wireguard is an important technology, but I don’t have a great understanding of it yet. So, of course, your mileage may vary.</p>

<p>PS. I also need to check on ipv6 support for this setup, but I don’t think my home internet provider supports it (lol).</p>

</article>
            </main>

            <footer class="mt-12 py-4 text-center text-xs text-gray-500 border-t font-light">
                <p>&copy; 2024 Server As Code Dot Com. All rights reserved.</p>
            </footer>

            <div class="issue-number-large">
                250
            </div>
        </div>
    </div>

<!-- Prism.js for syntax highlighting -->
<script src="/assets/js/prism.min.js"></script>
<script>
    // This script should be placed after the Prism.js script
    if (Prism.plugins && Prism.plugins.NormalizeWhitespace) {
        Prism.plugins.NormalizeWhitespace.setDefaults({
            'remove-trailing': true,
            'remove-indent': true,
            'left-trim': true,
            'right-trim': true
        });
    }

    // NOTE(curtis): None of the ``` in my posts had a language specified, so I'm setting it to bash by default
    Prism.highlightAll = (function (originalHighlightAll) {
        return function () {
            // For block code
            document.querySelectorAll('pre code:not([class*="language-"])')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                });

            // For inline code
            document.querySelectorAll('code:not([class*="language-"]):not(pre code)')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                    element.classList.add('inline-code');
                });

            originalHighlightAll.apply(this, arguments);
        }
    })(Prism.highlightAll);

    // NOTE(curtis): This is a custom function to highlight inline code as Prism doesn't do it by default
    function highlightInlineCode() {
        document.querySelectorAll('code.inline-code').forEach((block) => {
            Prism.highlightElement(block);
        });
    }

    // Re-run Prism highlighting after the page loads
    document.addEventListener('DOMContentLoaded', (event) => {
        Prism.highlightAll();
        highlightInlineCode();
    });
</script>
<script>
    const backgrounds = [
        '/img/background/background.png',
        '/img/background/background2.png',
        '/img/background/background3.png'
    ];
    const randomBackground = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = `url('${randomBackground}')`;
    document.body.style.backgroundRepeat = 'repeat';
</script>
<script>
 document.addEventListener('DOMContentLoaded', (event) => {
    const dropdownToggle = document.querySelector('.dropdown-toggle');
    const dropdownMenu = document.querySelector('.dropdown-menu');

    if (!dropdownToggle || !dropdownMenu) {
        console.error('Dropdown elements not found');
        return;
    }

    dropdownToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
    });

    // Close the dropdown if the user clicks outside of it
    window.addEventListener('click', function(event) {
        if (!event.target.matches('.dropdown-toggle')) {
            if (dropdownMenu.classList.contains('show')) {
                dropdownMenu.classList.remove('show');
            }
        }
    });

    // Handle all links in the dropdown menu
    document.querySelectorAll('.dropdown-menu a').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            dropdownMenu.classList.remove('show');

            const href = this.getAttribute('href');
            
            // Check if it's an external link or the feed.xml
            if (href.startsWith('http') || href.startsWith('https') || href === '/feed.xml') {
                window.open(href, '_blank');
                return;
            }

            // Check if it's the home or archive link
            if (href === '/' || href === '/archive.html') {
                window.location.href = href;
                return;
            }

            const isHomePage = window.location.pathname === '/' || window.location.pathname === '/index.html';
            
            if (isHomePage && href.includes('#')) {
                // If on home page and it's a section link, smooth scroll
                const targetId = href.split('#')[1];
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                // If on another page or it's not a section link, navigate to the page
                window.location.href = href;
            }
        });
    });
});

// Function to scroll to section after page load
function scrollToSection() {
    const hash = window.location.hash;
    if (hash) {
        const targetElement = document.querySelector(hash);
        if (targetElement) {
            setTimeout(() => {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
    }
}

// Call scrollToSection after page load
window.addEventListener('load', scrollToSection);
</script>

</body>
</html>