<!DOCTYPE html>
<html lang="en" class="min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three Steps to a Default Secure Kubernetes | Server As Code Dot Com</title>
    <meta name="description" content="A blog about technology">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">
    <link href="/assets/css/prism.min.css" rel="stylesheet">
    <link href="/assets/css/extra.css" rel="stylesheet">

    <!-- Twitter cards -->
    <meta name="twitter:site" content="serverascode.com">
    <meta name="twitter:creator" content="Curtis Collicutt">
    <meta name="twitter:title" content="Three Steps to a Default Secure Kubernetes">

    
    <meta name="twitter:description" content="<p>Kubernetes is a framework. We don’t usually describe it as a framework, but it is. IMHO, it’s a library we can use to deploy applications and imprint our organization’s policies and requirements on top of. That’s what makes it valuable, not the fact that it can create a container.</p>

">
    <!-- LinkedIn -->
    <meta property="og:description" content="<p>Kubernetes is a framework. We don’t usually describe it as a framework, but it is. IMHO, it’s a library we can use to deploy applications and imprint our organization’s policies and requirements on top of. That’s what makes it valuable, not the fact that it can create a container.</p>

" />
    

    
    
    
    
        
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https://serverascode.com/img/social/posts/three-steps-to-a-default-secure-kubernetes.png">
        <!-- LinkedIn -->
        <meta property="og:image" content="https://serverascode.com/img/social/posts/three-steps-to-a-default-secure-kubernetes.png" />
        

    
    <!-- end of Twitter cards -->

    <!-- Additional Open Graph tags for better LinkedIn sharing -->
    <meta property="og:title" content="Three Steps to a Default Secure Kubernetes" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://serverascode.com/2023/08/12/three-steps-to-a-default-secure-kubernetes.html" />
    <meta property="og:site_name" content="Server As Code Dot Com" />

</head>
<body class="font-sans">
    <div class="magazine-container">
        <header>
            <div class="magazine-header">
                <div class="issue-number-dropdown">
                    <button class="issue-number-top dropdown-toggle">
                        ISSUE 248
                        <span class="arrow-down"></span>
                    </button>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h3>Navigation</h3>
                            <a href="/">Home</a>
                            <a href="/archive.html">Archive</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Sections</h3>
                            <a href="/#latest-issues">Latest Issues</a>
                            <a href="/#tidal-series">Tidal Series</a>
                            <a href="/#connect-with-me">Connect With Me</a>
                            <a href="/#recent-posts">Recent Posts</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Connect</h3>
                            
                                
                            
                                
                                    <a href="https://tidalseries.com" target="_blank" rel="noopener noreferrer">TIDAL SERIES Newsletter</a>
                                
                            
                                
                                    <a href="https://www.linkedin.com/in/ccollicutt/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
                                
                            
                                
                                    <a href="https://taico.ca" target="_blank" rel="noopener noreferrer">TAICO - The Toronto AI and Cybersecurity Organization</a>
                                
                            
                                
                                    <a href="https://github.com/ccollicutt" target="_blank" rel="noopener noreferrer">GitHub</a>
                                
                            
                                
                                    <a href="https://huggingface.co/ccollicutt" target="_blank" rel="noopener noreferrer">Hugging Face</a>
                                
                            
                                
                            
                        </div>
                    </div>
                </div>
                <div class="magazine-info">
                    <div>Server As Code Dot Com</div>
                    <div class="underline"><a href="/archive.html">ARCHIVE</a></div>
                    <div class="underline">2024 JUNE</div>
                    <div class="underline">¥980</div>
                </div>
            </div>
            <p class="magazine-subtitle">A techno-blog for our techno-times</p>
            <a href="/" class="logo-link">
                <img src="/img/logo/logo.png" alt="Server As Code Dot Com" class="logo-image">
            </a>
        </header>

        <div class="content-wrapper">
            <main class="flex-grow px-4 md:px-8 main-content">
                <div class="max-w-4xl mx-auto px-4 mt-8 mb-12">
    <div class="flex justify-center space-x-4">
        
        
        <a href="https://serverascode.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/author/curtis.jpg" alt="Curtis Collicutt" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">Curtis Collicutt</span>
        </a>
        
        
        
        <a href="https://tidalseries.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/tidalseries.png" alt="TIDAL SERIES Newsletter" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">TIDAL SERIES Newsletter</span>
        </a>
        
        
        
        <a href="https://www.linkedin.com/in/ccollicutt/" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/linkedin.png" alt="LinkedIn" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">LinkedIn</span>
        </a>
        
        
        
        
        
        <a href="https://github.com/ccollicutt" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/github.jpg" alt="GitHub" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">GitHub</span>
        </a>
        
        
        
        
        
        
    </div>
</div>

<article class="prose lg:prose-xl mx-auto">
    <header class="mb-8 text-center not-prose">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-2">Three Steps to a Default Secure Kubernetes</h1>
        <p class="text-gray-600">
            <time datetime="2023-08-12T00:00:00-04:00">
                August 12, 2023
            </time>
            
        </p>
    </header>

    

    <p>Kubernetes is a framework. We don’t usually describe it as a framework, but it is. IMHO, it’s a library we can use to deploy applications and imprint our organization’s policies and requirements on top of. That’s what makes it valuable, not the fact that it can create a container.</p>

<p>Because it’s a basic framework, a set of lego blocks, it’s not designed to be secure “out of the box.” We’ve got to make it as secure as we need it to be.</p>

<h2 id="note-not-a-panacea">NOTE: Not a Panacea</h2>

<p>This post is an exploration of some things we could do to make Kubernetes more secure by default. Like what are a couple minimal steps we could take that have a large return on investment. It’s not meant to meet every organization’s requirements or be the end-all-be-all of security. It’s meant as an exploration of a secure starting point that could potentially work for everyone and every Kuberenetes.</p>

<p>In fact I should say here that I’ve already had people give me diffrent opinions on these settings. For example for network policies here I’m thinking more of lateral movement, but many organizations would prefer to stop outbound access. It really depends on your organization’s requirements.</p>

<h2 id="1---pod-security-standards">1 - Pod Security Standards</h2>

<p>First, if you’re not familiar with Pod Security Standards, it’s not a bad idea to <a href="https://serverascode.com/2023/08/02/making-pod-security-standards-default.html">go read up on them</a>, but suffice it to say let’s make sure every namespace has the following label.</p>

<pre><code>kubectl label namespace &lt;NAMESPACE&gt; pod-security.kubernetes.io/enforce=restricted
</code></pre>

<p>Which means:</p>

<ul>
  <li>Limit types of volumes</li>
  <li>Don’t run as root user</li>
  <li>No privilege escalation</li>
  <li>Seccomp profile set to “RuntimeDefault” or “Localhost”</li>
  <li>Drop all capabilities except perhaps add NET_BIND_SERVICE</li>
</ul>

<p>Here’s an example of running the nginx unprivileged container.</p>

<pre><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: nginx-meets-pod-security-standards
  namespace: enforcing
spec:
  containers:
  - image: nginxinc/nginx-unprivileged
	name: nginx
	securityContext:
  	allowPrivilegeEscalation: false
  	capabilities:
    	drop:
    	- ALL
  	runAsNonRoot: true
  	seccompProfile:
    	type: RuntimeDefault
EOF
</code></pre>

<p>That’s a pretty good start!</p>

<h2 id="2---network-policies">2 - Network Policies</h2>

<p>Historically, in Kubernetes, the connectivity was based on a giant, flat layer 3 network, which means every pod had an IP address and could talk to every other pod in the cluster. Obviously this doesn’t really work in enterprise environments, so Kubernetes added the ability to create <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">Network Policies</a>.</p>

<p>Here let’s create a default policy to ensure that pods in a namespace can talk to one another, but cannot talk to pods OUTSIDE of their namespace. This is super basic, but I like it as a starting point. Note that services would still be accessible, just not pods directly.</p>

<p>Here’s an example:</p>

<pre><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: namespace-only
spec:
  podSelector: {} # Selects all pods in the namespace
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {} # Allow pods in the same namespace to talk to one another
  egress:
  - to:
    - ipBlock:
   	 cidr: 0.0.0.0/0 # Allow egress to any destination
</code></pre>

<p>Obviously this can be taken a lot further, especially with a CNI that provides extra capabilities.</p>

<h2 id="3-runtime-threat-detection">3: Runtime Threat Detection</h2>

<p>The last step is to make sure that we’re monitoring our Kubernetes clusters for runtime threats. While we have a good baseline of security, something will always get through, no matter what we do. Any adversary worth their salt will find a way in, or mistakes will be made, etc. So we need to be able to detect them when they do. The only way to do that is to monitor the runtime environment.</p>

<p>We can do that in a couple of ways, one is to use Sysdig Secure, which is a commercial <a href="https://sysdig.com/learn-cloud-native/cloud-security/cloud-native-application-protection-platform-cnapp-fundamentals/">CNAPP (Cloud Native Application Protection Platform)</a> that has a decade of history in runtime protection. The other is to use Falco, which is an open source project that is part of the CNCF. Sysdig as a company supports the Falco project.</p>

<h3 id="3a---sysdig-secure">3a - Sysdig Secure</h3>

<p>Sysdig Secure is a security platform which has a decade of history in runtime protection.</p>

<p>It’s easy to sign up for a <a href="https://sysdig.com/start-free/">free trial</a> at Sysdig.</p>

<p>Then, install the agent into Kubernetes clusters with Helm:</p>

<pre><code>helm repo add sysdig https://charts.sysdig.com
helm repo update
helm install sysdig-agent --namespace sysdig-agent --create-namespace \
--set global.sysdig.accessKey=&lt;ACCESS_KEY&gt; \
--set global.sysdig.region=&lt;SAAS_REGION&gt; \
--set nodeAnalyzer.secure.vulnerabilityManagement.newEngineOnly=true \
--set global.kspm.deploy=true \
--set nodeAnalyzer.nodeAnalyzer.benchmarkRunner.deploy=false \
--set nodeAnalyzer.nodeAnalyzer.hostScanner.deploy=true
--set global.clusterConfig.name=&lt;CLUSTER_NAME&gt; \
sysdig/sysdig-deploy
</code></pre>

<p>Done!</p>

<h3 id="3b---falco">3b - Falco</h3>

<p><a href="https://falco.org/">Falco</a> is an open source project that is part of the CNCF. It’s a runtime threat detection engine that can be used to detect threats in Kubernetes clusters. Sysdig as a company supports the Falco project.</p>

<blockquote>
  <p>Falco is a cloud native runtime security tool for Linux operating systems. It is designed to detect and alert on abnormal behavior and potential security threats in real-time.
At its core, Falco is a kernel monitoring and detection agent that observes events, such as syscalls, based on custom rules. Falco can enhance these events by integrating metadata from the container runtime and Kubernetes. The collected events can be analyzed off-host in SIEM or data lake systems. - <a href="https://falco.org/">Falco</a></p>
</blockquote>

<p>Installing Falco into Kubernetes is easy, just use Helm:</p>

<pre><code>helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update
helm install falco falcosecurity/falco
</code></pre>

<p>Done!</p>

<h2 id="automation">Automation</h2>

<p>I would prefer that this all be done automatically. Because Kubernetes is a framework there are ways to make these kinds of security settings default, including the concepts of building operators and admission controllers. That would be my next step, to set up some tooling that would automatically apply these settings to every cluster, to every namespace, and to every pod.</p>

<p>So, look forward to a future blog post on that!</p>

<h2 id="conclusion">Conclusion</h2>

<p>I want to be clear that the point here is to create something that is simple and at the same time really improves the default security of Kubernetes–like what’s the best bang for the buck we can get in terms of security.</p>

<p>In this blog post we’ve seen how to create a higher level of default security for Kubernetes, and we looked at how to use Sysdig Secure and Falco to monitor the runtime environment for threats.</p>

<p>Ultimately, this post is an exploration of how to configure a Kubernetes cluster so that it is much more secure “by default.” There’s no need to have Kubernetes be so wide open.</p>

<p>PS. I’ve included an optional section discussing Buildpacks and how they can be used to create more secure container images.</p>

<h2 id="optional-buildpacks-and-paketo">OPTIONAL: Buildpacks and Paketo</h2>

<h3 id="background">Background</h3>

<p>Often people are surprised to find out that there is more than one way to build a container image. I mean, what’s a container image: it’s just a fancy tar file. There are many ways one can make a fancy tar file.</p>

<p>One way is <a href="https://buildpacks.io/">buildpacks</a>. I’ve written about them <a href="https://serverascode.com/2019/12/16/buidpack-pack.html">before</a>. <a href="https://paketo.io/">Paketo</a> is a set of buildpacks that are designed to be used with Kubernetes.</p>

<p>For the purposes of this blog post, the point of Vuildpacks is that they are a way to build a container image that is more secure by default. For example, buildpacks don’t run as root. If we just get rid of that one thing, we’ve made our container images more secure.</p>

<p>The value of Buildpacks:</p>

<ul>
  <li>Security - Buildpacks run as non-root by default.</li>
  <li>Advanced Caching - Robust caching is used to improve performance.</li>
  <li>Auto-detection -Images can be built directly from application source without additional instructions.</li>
  <li>Bill-of-Materials - Insights into the contents of the app image through standard build-time SBOMs in CycloneDX, SPDX and Syft JSON formats.</li>
  <li>Modular / Pluggable- Multiple buildpacks can be used to create an app image.</li>
  <li>Multi-language - Supports more than one programming language family.</li>
  <li>Multi-process - Image can have multiple entrypoints for each operational mode.</li>
  <li>Minimal app image - Image contains only what is necessary.</li>
  <li>Rebasing - Instant updates of base images without re-building.</li>
  <li>Reproducibility - Reproduces the same app image digest by re-running the build.</li>
  <li>Reusability - Leverage production-ready buildpacks maintained by the community.</li>
</ul>

<h3 id="paketo">Paketo</h3>

<p><a href="https://paketo.io/">Paketo</a> is a set of buildpacks that are designed to be used with Kubernetes.</p>

<p>First off this is a Python app and I’m using gunicorn, so we have a Procfile. This is really the only difference I have between a Dockerfile based image and a buildpack based image. Instead of a Dockerfile I have a Procfile, and the Procfile only describes the command to run the app, nothing else.</p>

<blockquote>
  <p>Procfiles define processes from your application’s code and contains one process per line.</p>
</blockquote>

<p>Here’s the example Procfile:</p>

<pre><code>$ cat Procfile
web: gunicorn app:app
</code></pre>

<p>Now we can build the image with a straight forward command.</p>

<blockquote>
  <p>NOTE: This assumes, of course, the pack CLI is installed.</p>
</blockquote>

<pre><code>pack build somepythonflaskapp \
  --buildpack paketo-buildpacks/python \
  --builder paketobuildpacks/builder:base
</code></pre>

<p>And deploy it into Kubernetes, port-forward to the service, and finally curl the app.</p>

<blockquote>
  <p>NOTE: This app is setup to report the user it’s running as.</p>
</blockquote>

<pre><code>$ curl localhost:8000
Application is running as user: cnb
</code></pre>

<p>Above we can see the app, which is configured to return the user it’s running as, is reporting that it is running as user “cnb” aka not root, aka Cloud Native Buildpacks. Done by default. Nice.</p>

</article>
            </main>

            <footer class="mt-12 py-4 text-center text-xs text-gray-500 border-t font-light">
                <p>&copy; 2024 Server As Code Dot Com. All rights reserved.</p>
            </footer>

            <div class="issue-number-large">
                248
            </div>
        </div>
    </div>

<!-- Prism.js for syntax highlighting -->
<script src="/assets/js/prism.min.js"></script>
<script>
    // This script should be placed after the Prism.js script
    if (Prism.plugins && Prism.plugins.NormalizeWhitespace) {
        Prism.plugins.NormalizeWhitespace.setDefaults({
            'remove-trailing': true,
            'remove-indent': true,
            'left-trim': true,
            'right-trim': true
        });
    }

    // NOTE(curtis): None of the ``` in my posts had a language specified, so I'm setting it to bash by default
    Prism.highlightAll = (function (originalHighlightAll) {
        return function () {
            // For block code
            document.querySelectorAll('pre code:not([class*="language-"])')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                });

            // For inline code
            document.querySelectorAll('code:not([class*="language-"]):not(pre code)')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                    element.classList.add('inline-code');
                });

            originalHighlightAll.apply(this, arguments);
        }
    })(Prism.highlightAll);

    // NOTE(curtis): This is a custom function to highlight inline code as Prism doesn't do it by default
    function highlightInlineCode() {
        document.querySelectorAll('code.inline-code').forEach((block) => {
            Prism.highlightElement(block);
        });
    }

    // Re-run Prism highlighting after the page loads
    document.addEventListener('DOMContentLoaded', (event) => {
        Prism.highlightAll();
        highlightInlineCode();
    });
</script>
<script>
    const backgrounds = [
        '/img/background/background.png',
        '/img/background/background2.png',
        '/img/background/background3.png'
    ];
    const randomBackground = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = `url('${randomBackground}')`;
    document.body.style.backgroundRepeat = 'repeat';
</script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        const dropdownMenu = document.querySelector('.dropdown-menu');
    
        if (!dropdownToggle || !dropdownMenu) {
            console.error('Dropdown elements not found');
            return;
        }
    
        dropdownToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });
    
        // Close the dropdown if the user clicks outside of it
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                if (dropdownMenu.classList.contains('show')) {
                    dropdownMenu.classList.remove('show');
                }
            }
        });
    
        // Handle all links in the dropdown menu
        document.querySelectorAll('.dropdown-menu a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                dropdownMenu.classList.remove('show');
    
                const href = this.getAttribute('href');
                
                // Check if it's an external link
                if (href.startsWith('http') || href.startsWith('https')) {
                    window.open(href, '_blank');
                    return;
                }
    
                // Check if it's the home or archive link
                if (href === '/' || href === '/archive.html') {
                    window.location.href = href;
                    return;
                }
    
                const isHomePage = window.location.pathname === '/' || window.location.pathname === '/index.html';
                
                if (isHomePage && href.includes('#')) {
                    // If on home page and it's a section link, smooth scroll
                    const targetId = href.split('#')[1];
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    // If on another page or it's not a section link, navigate to the page
                    window.location.href = href;
                }
            });
        });
    });
    
    // Function to scroll to section after page load
    function scrollToSection() {
        const hash = window.location.hash;
        if (hash) {
            const targetElement = document.querySelector(hash);
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }
    }
    
    // Call scrollToSection after page load
    window.addEventListener('load', scrollToSection);
</script>

</body>
</html>