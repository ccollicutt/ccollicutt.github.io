<!DOCTYPE html>
<html lang="en" class="min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use squid to cache RedHat/CentOS yum repositories | Server As Code Dot Com</title>
    <meta name="description" content="A techno-blog for our techno-times">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">
    <link href="/assets/css/prism.min.css" rel="stylesheet">
    <link href="/assets/css/extra.css" rel="stylesheet">

    <meta name="twitter:site" content="serverascode.com">
    <meta name="twitter:creator" content="Curtis Collicutt">
    
    
        <meta name="twitter:title" content="Use squid to cache RedHat/CentOS yum repositories">
        
        <meta name="twitter:description" content="Today I began working on adding RedHat/CentOS support to my Ansible based project Swiftacular which deploys OpenStack Swift.

">
        <meta property="og:description" content="Today I began working on adding RedHat/CentOS support to my Ansible based project Swiftacular which deploys OpenStack Swift.

" />
        
        <meta property="og:title" content="Use squid to cache RedHat/CentOS yum repositories" />
        <meta property="og:type" content="article" />
    
    
    
    
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://serverascode.com/img/social/posts/squid-cache-yum.png">
    <meta property="og:image" content="https://serverascode.com/img/social/posts/squid-cache-yum.png" />
    
    
    <meta property="og:url" content="https://serverascode.com/2014/03/29/squid-cache-yum.html" />
    <meta property="og:site_name" content="Server As Code Dot Com" />
</head>
<body class="font-sans">
    <div class="magazine-container">
        <header>
            <div class="magazine-header">
                <div class="issue-number-dropdown">
                    <button class="issue-number-top dropdown-toggle">
                        ISSUE 248
                        <span class="arrow-down"></span>
                    </button>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h3>Navigation</h3>
                            <a href="/">Home</a>
                            <a href="/archive.html">Archive</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Sections</h3>
                            <a href="/#latest-issues">Latest Issues</a>
                            <a href="/#tidal-series">Tidal Series</a>
                            <a href="/#connect-with-me">Connect With Me</a>
                            <a href="/#recent-posts">Recent Posts</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Connect</h3>
                            
                                
                            
                                
                                    <a href="https://tidalseries.com" target="_blank" rel="noopener noreferrer">TIDAL SERIES Newsletter</a>
                                
                            
                                
                                    <a href="https://www.linkedin.com/in/ccollicutt/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
                                
                            
                                
                                    <a href="https://taico.ca" target="_blank" rel="noopener noreferrer">TAICO - The Toronto AI and Cybersecurity Organization</a>
                                
                            
                                
                                    <a href="https://github.com/ccollicutt" target="_blank" rel="noopener noreferrer">GitHub</a>
                                
                            
                                
                                    <a href="https://huggingface.co/ccollicutt" target="_blank" rel="noopener noreferrer">Hugging Face</a>
                                
                            
                                
                            
                        </div>
                    </div>
                </div>
                <div class="magazine-info">
                    <div>Server As Code Dot Com</div>
                    <div class="underline"><a href="/archive.html">ARCHIVE</a></div>
                    <div class="underline">2024 JUNE</div>
                    <div class="underline">¥980</div>
                </div>
            </div>
            <p class="magazine-subtitle">A techno-blog for our techno-times</p>
            <a href="/" class="logo-link">
                <img src="/img/logo/logo.png" alt="Server As Code Dot Com" class="logo-image">
            </a>
        </header>

        <div class="content-wrapper">
            <main class="flex-grow px-4 md:px-8 main-content">
                <div class="max-w-4xl mx-auto px-4 mt-8 mb-12">
    <div class="flex justify-center space-x-4">
        
        
        <a href="https://serverascode.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/author/curtis.jpg" alt="Curtis Collicutt" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">Curtis Collicutt</span>
        </a>
        
        
        
        <a href="https://tidalseries.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/tidalseries.png" alt="TIDAL SERIES Newsletter" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">TIDAL SERIES Newsletter</span>
        </a>
        
        
        
        <a href="https://www.linkedin.com/in/ccollicutt/" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/linkedin.png" alt="LinkedIn" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">LinkedIn</span>
        </a>
        
        
        
        
        
        <a href="https://github.com/ccollicutt" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/github.jpg" alt="GitHub" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">GitHub</span>
        </a>
        
        
        
        
        
        
    </div>
</div>

<article class="prose lg:prose-xl mx-auto">
    <header class="mb-8 text-center not-prose">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-2">Use squid to cache RedHat/CentOS yum repositories</h1>
        <p class="text-gray-600">
            <time datetime="2014-03-29T00:00:00-04:00">
                March 29, 2014
            </time>
            
        </p>
    </header>

    

    <p>Today I began working on adding RedHat/CentOS support to my Ansible based project <a href="https://github.com/ccollicutt/swiftacular">Swiftacular</a> which deploys <a href="http://docs.openstack.org/developer/swift/">OpenStack Swift</a>.</p>

<p>Because, right now, it takes several Vagrant/Virtualbox virtual machines to run swiftacular, I like to make sure that I configure a local package caching server so that I don’t kill my Internet connection by downloading the same package multiple times.</p>

<p>When configuring Ubuntu vms I use apt-cacher-ng. But with RedHat I couldn’t find, at least in a quick google search, a similar system for RedHat. (Though apparently apt-cacher-ng can cache rpms, but I haven’t tried it with Redhat repos.)</p>

<p>I opted just to use squid. Surprisingly I couldn’t find much for blog posts on using squid to proxy yum so I thought I’d post what I did, which is very simple, in case anyone else was trying to do the same thing.</p>

<p>I imagine there are better ways to cache rpms locally, ie. on a laptop, but this is what I did. :)</p>

<h2 id="setup-squid">Setup squid</h2>

<p>First, I installed squid on the package caching server.</p>

<pre>
<code>cache# yum install squid
</code>
</pre>

<p>The one change I have made to the squid configuration file is to set a cache_dir.</p>

<pre>
<code>cache# grep cache_dir /etc/squid/squid.conf
#cache_dir ufs /var/spool/squid 100 16 256
cache_dir ufs /var/spool/squid 7000 16 256
</code>
</pre>

<p>The first uncommented cache_dir is the default, which is not set unless uncommented. The second is my setting, which just has a larger maximum size for the cache directory. You could set that to whatever is appropriate for your environment.</p>

<p>You’ll also have to allow connections to port 3128 via iptables, or just shut iptables down. (Normally I wouldn’t shut iptables down, but this is just for a test system.)</p>

<p>Also note I started squid.</p>

<pre>
<code>cache# netstat -ant | grep 3128
tcp        0      0 :::3128                     :::*                        LISTEN 
cache# service iptables stop
SNIP!
cache# service squid start
</code>
</pre>

<p>So far so good.</p>

<h2 id="configure-the-servers-that-will-use-the-package-cache">Configure the servers that will use the package cache</h2>

<p>On all the servers that need to use the cache, I set the proxy configuration in their /etc/yum.conf file to be the cache server on port 3128.</p>

<pre>
<code>server# head -12 yum.conf
[main]
cachedir=/var/cache/yum/$basearch/$releasever
keepcache=0
debuglevel=2
logfile=/var/log/yum.log
exactarch=1
obsoletes=1
gpgcheck=1
plugins=1
installonly_limit=5
proxy=http://192.168.100.20:3128
</code>
</pre>

<p>Also, I commented out the mirrorlist lines in CentOS-Base.repo and uncommented the baseurl, eg.</p>

<pre>
<code>[vagrant@swift-storage-02 yum.repos.d]$ grep "mirrorlist\|baseurl" CentOS-Base.repo 
# If the mirrorlist= does not work for you, as a fall back you can try the 
# remarked out baseurl= line instead.
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=os
baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=updates
baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=extras
baseurl=http://mirror.centos.org/centos/$releasever/extras/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=centosplus
baseurl=http://mirror.centos.org/centos/$releasever/centosplus/$basearch/
#mirrorlist=http://mirrorlist.centos.org/?release=$releasever&amp;arch=$basearch&amp;repo=contrib
baseurl=http://mirror.centos.org/centos/$releasever/updates/$basearch/
</code>
</pre>

<p>Normally you wouldn’t want to do this, but because of the mirror list there will be many squid cache misses. So baseurl is better, and a closer mirror would be better still.</p>

<p>Next I removed the fastestmirror plugin:</p>

<pre>
<code>server# rm -f /etc/yum/pluginconf.d/fastestmirror.conf 
</code>
</pre>

<p>As an example, if I install php-common on one of the servers, then install it on another, it will hit the squid cache and just download it from there. So we only download the package once from the Internet, even if it’s installed on several servers.</p>

<pre>
<code>1396152104.396     10 192.168.100.202 TCP_HIT/200 537778 GET \
 http://mirror.centos.org/centos/6/updates/x86_64/Packages/php-common-5.3.3-27.el6_5.x86_64.rpm \
 - NONE/- application/x-rpm
</code>
</pre>

<p>That’s all it takes.</p>

<p>One thing I’m not sure about is the cache expiry time. I’m sure there are some other changes I will come across while using squid to cache yum repos, as I’ve only started using it in the last few hours, but I will ensure to come back and edit this post with new information.</p>

<p>If anyone has any comment, questions, concerns, or criticisms, do let me know. :)</p>

<h2 id="ansible">Ansible</h2>

<p>PS. Everything I’m doing above is automated with <a href="http://ansible.com">Ansible</a>.</p>

<h2 id="updates">Updates</h2>

<ul>
  <li>Added removing fastestmirror plugin</li>
</ul>

</article>
            </main>

            <footer class="mt-12 py-4 text-center text-xs text-gray-500 border-t font-light">
                <p>&copy; 2024 Server As Code Dot Com. All rights reserved.</p>
            </footer>

            <div class="issue-number-large">
                248
            </div>
        </div>
    </div>

<!-- Prism.js for syntax highlighting -->
<script src="/assets/js/prism.min.js"></script>
<script>
    // This script should be placed after the Prism.js script
    if (Prism.plugins && Prism.plugins.NormalizeWhitespace) {
        Prism.plugins.NormalizeWhitespace.setDefaults({
            'remove-trailing': true,
            'remove-indent': true,
            'left-trim': true,
            'right-trim': true
        });
    }

    // NOTE(curtis): None of the ``` in my posts had a language specified, so I'm setting it to bash by default
    Prism.highlightAll = (function (originalHighlightAll) {
        return function () {
            // For block code
            document.querySelectorAll('pre code:not([class*="language-"])')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                });

            // For inline code
            document.querySelectorAll('code:not([class*="language-"]):not(pre code)')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                    element.classList.add('inline-code');
                });

            originalHighlightAll.apply(this, arguments);
        }
    })(Prism.highlightAll);

    // NOTE(curtis): This is a custom function to highlight inline code as Prism doesn't do it by default
    function highlightInlineCode() {
        document.querySelectorAll('code.inline-code').forEach((block) => {
            Prism.highlightElement(block);
        });
    }

    // Re-run Prism highlighting after the page loads
    document.addEventListener('DOMContentLoaded', (event) => {
        Prism.highlightAll();
        highlightInlineCode();
    });
</script>
<script>
    const backgrounds = [
        '/img/background/background.png',
        '/img/background/background2.png',
        '/img/background/background3.png'
    ];
    const randomBackground = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = `url('${randomBackground}')`;
    document.body.style.backgroundRepeat = 'repeat';
</script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        const dropdownMenu = document.querySelector('.dropdown-menu');
    
        if (!dropdownToggle || !dropdownMenu) {
            console.error('Dropdown elements not found');
            return;
        }
    
        dropdownToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });
    
        // Close the dropdown if the user clicks outside of it
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                if (dropdownMenu.classList.contains('show')) {
                    dropdownMenu.classList.remove('show');
                }
            }
        });
    
        // Handle all links in the dropdown menu
        document.querySelectorAll('.dropdown-menu a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                dropdownMenu.classList.remove('show');
    
                const href = this.getAttribute('href');
                
                // Check if it's an external link
                if (href.startsWith('http') || href.startsWith('https')) {
                    window.open(href, '_blank');
                    return;
                }
    
                // Check if it's the home or archive link
                if (href === '/' || href === '/archive.html') {
                    window.location.href = href;
                    return;
                }
    
                const isHomePage = window.location.pathname === '/' || window.location.pathname === '/index.html';
                
                if (isHomePage && href.includes('#')) {
                    // If on home page and it's a section link, smooth scroll
                    const targetId = href.split('#')[1];
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    // If on another page or it's not a section link, navigate to the page
                    window.location.href = href;
                }
            });
        });
    });
    
    // Function to scroll to section after page load
    function scrollToSection() {
        const hash = window.location.hash;
        if (hash) {
            const targetElement = document.querySelector(hash);
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }
    }
    
    // Call scrollToSection after page load
    window.addEventListener('load', scrollToSection);
</script>

</body>
</html>