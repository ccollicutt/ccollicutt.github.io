<!DOCTYPE html>
<html lang="en" class="min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenStack Multi-site, Multi-clouds, and Distributed Clouds | Server As Code Dot Com</title>
    <meta name="description" content="A techno-blog for our techno-times">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">
    <link href="/assets/css/prism.min.css" rel="stylesheet">
    <link href="/assets/css/extra.css" rel="stylesheet">

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">
    <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <meta name="twitter:site" content="serverascode.com">
    <meta name="twitter:creator" content="Curtis Collicutt">
    
    
        <meta name="twitter:title" content="OpenStack Multi-site, Multi-clouds, and Distributed Clouds">
        
        <meta name="twitter:description" content="One OpenStack cloud is rarely enough. Most organizations that deploy one OpenStack cloud will, at some point, at least think about deploying a second. Some o...">
        <meta property="og:description" content="One OpenStack cloud is rarely enough. Most organizations that deploy one OpenStack cloud will, at some point, at least think about deploying a second. Some o..." />
        
        <meta property="og:title" content="OpenStack Multi-site, Multi-clouds, and Distributed Clouds" />
        <meta property="og:type" content="article" />
    
    
    
    
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://serverascode.com/img/social/posts/openstack-multisite-multicloud.png">
    <meta property="og:image" content="https://serverascode.com/img/social/posts/openstack-multisite-multicloud.png" />
    
    
    <meta property="og:url" content="https://serverascode.com/2017/05/09/openstack-multisite-multicloud.html" />
    <meta property="og:site_name" content="Server As Code Dot Com" />
    <script defer data-domain="serverascode.com" src="https://plausible.io/js/script.js"></script>
</head>
<body class="font-sans">
    <div class="magazine-container">
        <header>
            <div class="magazine-header">
                <div class="issue-number-dropdown">
                    <button class="issue-number-top dropdown-toggle">
                        ISSUE 265
                        <span class="arrow-down"></span>
                    </button>
                    <div class="dropdown-menu">
                        <div class="dropdown-section">
                            <h3>Navigation</h3>
                            <a href="/">Home</a>
                            <a href="/archive.html">Archive</a>
                            <a href="/feed.xml">RSS Feed</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Sections</h3>
                            <a href="/#latest-issues">Latest Issues</a>
                            <a href="/#projects">Software Projects</a>
                            <a href="/#tidal-series">Tidal Series</a>
                            <a href="/#connect-with-me">Connect With Me</a>
                            <a href="/#recent-posts">Recent Posts</a>
                        </div>
                        <div class="dropdown-section">
                            <h3>Connect</h3>
                            
                                
                            
                                
                                    <a href="https://tidalseries.substack.com" target="_blank" rel="noopener noreferrer">TIDAL SERIES Newsletter</a>
                                
                            
                                
                                    <a href="https://www.linkedin.com/in/ccollicutt/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
                                
                            
                                
                                    <a href="https://taico.ca" target="_blank" rel="noopener noreferrer">TAICO - The Toronto AI and Cybersecurity Organization</a>
                                
                            
                                
                                    <a href="https://github.com/ccollicutt" target="_blank" rel="noopener noreferrer">GitHub</a>
                                
                            
                                
                                    <a href="https://huggingface.co/ccollicutt" target="_blank" rel="noopener noreferrer">Hugging Face</a>
                                
                            
                                
                            
                        </div>
                    </div>
                </div>
                <div class="magazine-info">
                    <div>Server As Code Dot Com</div>
                    <div class="underline"><a href="/archive.html">ARCHIVE</a></div>
                    <div class="underline">2025 NOVEMBER</div>
                    <div class="underline">¥980</div>
                </div>
            </div>
            <p class="magazine-subtitle">A techno-blog for our techno-times</p>
            <a href="/" class="logo-link">
                <img src="/img/logo/logo.png" alt="Server As Code Dot Com" class="logo-image">
            </a>
        </header>

        <div class="content-wrapper">
            <main class="flex-grow px-4 md:px-8 main-content">
                <div class="max-w-4xl mx-auto px-4 mt-8 mb-12">
    <div class="flex justify-center space-x-4">
        
        
        <a href="https://serverascode.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/author/curtis.jpg" alt="Curtis Collicutt" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">Curtis Collicutt</span>
        </a>
        
        
        
        <a href="https://tidalseries.substack.com" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/tidalseries.png" alt="TIDAL SERIES Newsletter" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">TIDAL SERIES Newsletter</span>
        </a>
        
        
        
        <a href="https://www.linkedin.com/in/ccollicutt/" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/linkedin.png" alt="LinkedIn" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">LinkedIn</span>
        </a>
        
        
        
        
        
        <a href="https://github.com/ccollicutt" class="group flex flex-col items-center bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300 p-3" target="_blank" rel="noopener noreferrer">
            <img src="/img/cards/github.jpg" alt="GitHub" class="w-14 h-14 object-cover rounded-full mb-2">
            <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 text-center">GitHub</span>
        </a>
        
        
        
        
        
        
    </div>
</div>

<article class="prose lg:prose-xl mx-auto">
    <header class="mb-8 text-center not-prose">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-2">OpenStack Multi-site, Multi-clouds, and Distributed Clouds</h1>
        <p class="text-gray-600">
            <time datetime="2017-05-09T00:00:00-04:00">
                May 09, 2017
            </time>
            
        </p>
    </header>

    <div id="toc" class="hidden mb-8 p-4 bg-gray-50 rounded-lg not-prose">
        <h2 class="text-lg font-semibold mb-2">Table of Contents</h2>
        <nav id="toc-content"></nav>
    </div>

    

    <p>One OpenStack cloud is rarely enough. Most organizations that deploy one OpenStack cloud will, at some point, at least think about deploying a second. Some organizations will not only want to depoy a couple clouds, but maybe 10, or 20, or 50…or even more. In some industries, such as telecommunications, organizations may want to deploy hundreds of OpenStack instances. And, as unbelievable as it sounds, some use cases require thousands. But what are the options available when deploying more than one OpenStack cloud? How would we deploy 2, 10, or 100+ clouds?</p>

<p>In this post I will go over some options and their pros and cons, as well as consider some of the features and architectural changes OpenStack may need to implement in order to meet the requirements of use cases such as massively distributed clouds.</p>

<p>I should also mention that this post is based on a talk I did at the 2017 Boston OpenStack summit with two colleagues, Adrien Lebre and Chaoyi Huang. Adrien is the chair of the “Fog, Edge, and Massively Distributed Working Group” and Chaoyi works on the Tricircle and Kingbird projects and is active in many areas of Network Function Virtualization (NFV). I learned a lot from the two of them while putting together the presentation. I won’t link to the video here, because I’m not a huge fan of being recorded, but a simple Youtube search will find it. :)</p>

<h2 id="definitions">Definitions</h2>

<p>Terminology for multiple OpenStack clouds is difficult. Some people use different terms for the same thing, and use the same terms for different things. I’ll make a couple of definitions, but be aware that other people might not use them the same way I do, or might disagree with my choices.</p>

<p><strong>Regions/Multi-region</strong>: When I talk about multi-region, I essentially mean that the OpenStack Keystone database is shared in some fashion.</p>

<p><strong>Mult-site</strong>: I define multi-site as having multiple OpenStack clouds, but no shared Keystone.</p>

<p><strong>Fog/Edge/Massively Distributed</strong>: I will use these interchangeably. Essentially it means that we have many small “data centers” (which may not be datacenters at all) and there will be only a few hypervisors located there–the OpenStack control plane will be remote, ie. in a different datacenter. This is for use cases like retail and such where an organization has thousands of locations, and many one or two hypervisors in each location.</p>

<p><img src="/img/shared-keystone.jpg" alt="shared keystone" /></p>

<h2 id="openstack-regions---the-historical-method">OpenStack Regions - The Historical Method</h2>

<p>I used to work at a public cloud in Canada which was based on OpenStack. We planned on having two OpenStack regions in Canada, one in Vancouver and one in Toronto. OpenStack regions are a good way to manage authentication and authorization for two or three OpenStack clouds (or more, depending on your risk profile). The fact that I mention authorization (authz) and authentication (authn) is important, because in general this is all regions provide–shared identity. Only Keystone (and potentially Glance and Horizon) are suited for being shared across regions. Most of the other services, such as Nova and Neutron, will have completely separate installations in each region, and are not shared.</p>

<p>We’ve established that with regions we share Keystone in some fashion. In the image above, we can see a simplistic diagram of a Keystone that is shared across datacenters of a secure, private link. Each datacenter has MySQL Galera nodes that are part of a Galera cluster that exists across multiple datacenters.</p>

<p>To share the Keystone across mutliple datacenters you have three main options:</p>

<p><strong>Centralized Keystone DB</strong>: In this model there is only one centralized Keystone database, and the other regions access the database directly via the WAN link; they have no local Keystone DB.</p>

<p><strong>Asyncronous Keystone DB</strong>: Here you would have database instances in each region/DC, but only one would be the “master” version (ie. read/write) and the other regions would have their DBs asynchronously updated by the master, ie. they would be <a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-primary-secondary-replication.html">secondary databases</a>.</p>

<p><strong>Syncronous (Clustered) Keystone DB</strong>: Using MySQL/MaraiDB Galera clustering, the Keystone database would be synchronously shared across all regions. This is the model that is usually given as an example of regions.</p>

<p>All of these options have pros and cons. Asynchronous is probably the most scalable model, but overall my opinion is that none of these are all that useful. Essentially regions, as I define them, are no longer a good option.</p>

<p>The reality is that all a shared Keystone model buys you is shared authz/authn. We still have all kinds of other issues to deal with, from keys to images to determining how to share Neutron tenant networks across clouds. There are things that every OpenStack multi-cloud deployer wants, and regions don’t help with any of that. Further to this, using a shared Keystone has some additional cons, such as operational complexity, and the fact that the Keystone version would probably have to be the same across all clouds, making upgrades slightly more difficult.</p>

<p><img src="/img/cells-v2.jpg" alt="Cells V2" /></p>

<h2 id="nova-cells-v2">Nova Cells V2</h2>

<p>Nova has had a cell model (V1) for quite some time. Essentially it allows the creation of reduced (Nova) failure domains and allows for better scalability. In V2 this is accomplished by adding a <code>nova_api</code> DB to the control plan, and a <code>nova</code> DB in the cell. Also each Cell has its own messaging queue (aka RabbitMQ). However, V1 is not widely used, and in fact I was recently at a OpenStack summit where Nova developers mentioned that they are surprised V1 even works.</p>

<p>However, V2 is is now default in OpenStack Ocata+. If you deploy Ocata you will have one cell. However, Cells V2 is not yet done, and in fact you can’t add additional cells. Right now you can have as many cells as you want as long as it’s one. This is expected to change in Pike or Queens. The point is that V2 will now be widely used, and at some point will be usable, and will enable Nova to be highly scalable.</p>

<p>Unfortunately, this is just for Nova. I would love to see a similar model applied to all major OpenStack projects. But even if they all decided they wanted to do that, it would probably take a couple years for the changes to make their way into the releases.</p>

<p>I’d also like to mention that, at least when Cells V2 is production ready, using it in combination with something like <a href="https://docs.openstack.org/newton/networking-guide/config-routed-networks.html">routed provider networks</a> would be extremely powerful. I would consider routed provider networks complimentary to cells. Imagine doing Nova Cells V2 on a per rack basis, and also routed provider networks.</p>

<h2 id="shared-ldap">Shared LDAP</h2>

<p>I should note that Keystone can authenticate to a LDAP backend, and that backend could be shared/synced across many clouds. Often this is done with Active Directory (which I know nothing about). But, of course, this just provides shared authn.</p>

<h2 id="shared-nothing-multi-cloud">Shared-Nothing Multi-cloud</h2>

<p>Mirantis has a good <a href="https://www.mirantis.com/blog/scaling-openstack-shared-nothing-architecture/">blog post</a> on shared-nothing OpenStack multi-cloud. On first blush, it seems overly simplistic. We just deploy a bunch of completely separate clouds.</p>

<p>The reality is that you can’t just stop there. In a multi-cloud deployment with shared-nothing we are going to have to rely on some kind of 3rd party abstraction layer that sits above the clouds and manages users, groups, keys, images, etc. There is a lot of work required to implement that kind of model, as at least the 3rd party “cloud broker” must be implemented or developed. But, as Mirantis mentions, there are a lot of pros to using this model.</p>

<p>Realistically, if you are deploying 10s or 100s of clouds, this is probably the only model that will work (at least at this time).</p>

<h3 id="etsi-mano">ETSI MANO</h3>

<p>Over the last year or so I have been doing a lot of work within the realm of “Network Function Virtualization” (NFV). The European Telecommunications Standards Institution (ETSI) has defined some NFV components. One of those complements is the “Management and Orchestration” (MANO) system. I’m sure there is a proper, specific definition for MANO, but I tend to see it as an amorphous blob that can take any shape and perform any function (ie. the ultimate lock-in).</p>

<p>There are several MANO vendors and <a href="http://about.att.com/innovationblog/onap">open source projects</a>. Suffice it to say that overall it seems like the MANO layer would not mind taking complete control of all OpenStack clouds. I’m not so sure that is a good idea, and may not be in OpenStack’s best interest. However, that doesn’t mean it’s not the best solution for telecommunications companies, such as AT&amp;T. That said, MANO systems won’t be able to do absolutely everything without some help from additional projects, especially around networking.</p>

<p><img src="/img/federation.jpg" alt="Federation" /></p>

<h2 id="openstack-federation">OpenStack Federation</h2>

<p><a href="https://docs.openstack.org/developer/keystone/federation/federated_identity.html">Federation</a> is a powerful technology that essentially allows one cloud to trust the users of another. The canonical use case for federation is when non-profit or academic institutions would like to enable their cloud users to utilize resources in another organizations cloud (and potentially vice-versa). Further to this, it could also be used as a form of centralized identity.</p>

<p>For this blog post I just want to go over some potential solutions, and don’t want to go in depth into any of the solutions in particular. In future blog posts I hope to go into federation more deeply.</p>

<h2 id="tricircle-and-kingbird">Tricircle and Kingbird</h2>

<p>There are a couple of projects I would like to mention that could be used to help deploy multiple clouds. As mentioned, it’s often desirable to have networking in OpenStack understand multi-cloud. <a href="https://wiki.openstack.org/wiki/Tricircle">Tricircle</a> helps with this. Further, as mentioned, even if we used regions, we would still have to manage keys, images, and such. This is where <a href="https://wiki.openstack.org/wiki/Kingbird">Kingbird</a> enters the picture.</p>

<p>I can’t comment much more on either of those projects as I have not used them. But, suffice it to say that they are in active development and are very important for organizations such as telecommunications companies who would like to deploy tens or hundreds of clouds.</p>

<h2 id="fog-edge-and-massively-distributed">Fog, Edge, and Massively distributed</h2>

<p>As previously mentioned, there are use cases, such as retail stores with a couple hypervisors in each store, which we would consider as requiring some kind of massively distributed deployment model. This model does not currently exist, but there is a <a href="https://wiki.openstack.org/wiki/Fog_Edge_Massively_Distributed_Clouds">working group</a> within the OpenStack community that is defining the surrounding use-cases, and over time will begin to define a recommended implementation.</p>

<p>It’s also fairly apparent to me that the OpenStack Foundation would like to see this use case supported. It is going to take a considerable amount of work to enable this use case, but over the next few releases I would expect to see it being earnestly discussed and worked on at some level. I’m excited to see increasing interest in the edge model, as to enable it we’ll have to make substantial changes to OpenStack.</p>

<h2 id="conclusion">Conclusion</h2>

<p>OpenStack has some fairly rich authn/authz models. Unfortunately, my go to multi-cloud model of yesteryear, regions, doesn’t work (IMHO) when you have more than a handful of clouds, and doesn’t provide all that many features anyways. NFV deployments, and deployments requiring massively distributed hypervisors, won’t be able to use regions (not that they would help anyways), so we have to look at other models, some of which don’t yet exist.</p>

<p>Likely we will require a combination of tools such as software defined networking, perhaps Tricircle, Kingbird and massively distributed in order to deploy and operate large numbers of clouds. Generally speaking the telecommunications industry is going to drive these requirements as they are the ones that need thousands of tiny clouds or hundreds of small/medium ones.</p>

<p>It’s an exciting time in OpenStack, partially because I’m not sure what is going to happen. Will OpenStack pivot to support large NFV deployments? I think they will have to in order to continue to grow, assuming that is a goal. If not, then it is hard to say. Perhaps I’m just in denial that OpenStack just has to be able to provide shared-nothing clouds and some magical MANO or other higher layer abstraction along with SDN solutions and a couple cell-like models will be enough. What’s more, there does seem to be a lot of interest in creating an Open Source MANO solution, for example <a href="https://www.onap.org/">ONAP</a>.</p>

</article>
            </main>

            <footer class="mt-12 py-4 text-center text-xs text-gray-500 border-t font-light">
                <p>&copy; 2025 Server As Code Dot Com. All rights reserved.</p>
            </footer>

            <div class="issue-number-large">
                265
            </div>
        </div>
    </div>

<!-- Prism.js for syntax highlighting -->
<script src="/assets/js/prism.min.js"></script>
<script>
    // This script should be placed after the Prism.js script
    if (Prism.plugins && Prism.plugins.NormalizeWhitespace) {
        Prism.plugins.NormalizeWhitespace.setDefaults({
            'remove-trailing': true,
            'remove-indent': true,
            'left-trim': true,
            'right-trim': true
        });
    }

    // NOTE(curtis): None of the ``` in my posts had a language specified, so I'm setting it to bash by default
    Prism.highlightAll = (function (originalHighlightAll) {
        return function () {
            // For block code
            document.querySelectorAll('pre code:not([class*="language-"])')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                });

            // For inline code
            document.querySelectorAll('code:not([class*="language-"]):not(pre code)')
                .forEach(function(element) {
                    element.classList.add('language-bash');
                    element.classList.add('inline-code');
                });

            originalHighlightAll.apply(this, arguments);
        }
    })(Prism.highlightAll);

    // NOTE(curtis): This is a custom function to highlight inline code as Prism doesn't do it by default
    function highlightInlineCode() {
        document.querySelectorAll('code.inline-code').forEach((block) => {
            Prism.highlightElement(block);
        });
    }

    // Re-run Prism highlighting after the page loads
    document.addEventListener('DOMContentLoaded', (event) => {
        Prism.highlightAll();
        highlightInlineCode();
    });

    // Table of Contents Generator
    document.addEventListener('DOMContentLoaded', function() {
        const article = document.querySelector('article.prose');
        if (!article) return;

        // Get all headers from the article content (h2-h4), excluding those in tables
        const headers = Array.from(article.querySelectorAll('h2, h3, h4')).filter(header => {
            // Exclude headers in tables, TOC itself, and any header containing "Table of Contents"
            return !header.closest('table') && 
                   !header.closest('.toc') && 
                   header.textContent.trim() !== 'Table of Contents' &&
                   !header.textContent.includes('Table of Contents');
        });

        // Only generate TOC if there are more than 3 headers
        if (headers.length <= 3) return;

        // Create and initialize TOC container
        const tocContainer = createTOCContainer();
        tocContainer.id = 'toc-container';
        
        // Generate TOC content
        const { toc, sectionInfo } = generateTOCContent(headers);
        
        // Add TOC to container
        tocContainer.appendChild(toc);
        
        // Insert TOC in the appropriate location
        insertTOC(article, tocContainer);

        // Create floating button container
        const floatingContainer = document.createElement('div');
        floatingContainer.className = 'floating-container prose mx-auto text-center mt-8 mb-4';
        floatingContainer.style.cssText = `
            width: 100%;
            max-width: 65ch;
        `;

        // Create the button
        const backButton = document.createElement('button');
        backButton.textContent = '↑ Back to Contents';
        backButton.className = 'bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-700 transition-all duration-200';
        backButton.style.cssText = `
            font-size: 0.875rem;
        `;

        floatingContainer.appendChild(backButton);
        article.appendChild(floatingContainer);

        // Scroll back to TOC when clicked
        backButton.addEventListener('click', () => {
            tocContainer.scrollIntoView({ behavior: 'smooth' });
        });

        // Enable smooth scrolling
        document.documentElement.style.scrollBehavior = 'smooth';
    });

    function createTOCContainer() {
        const container = document.createElement('div');
        container.className = 'toc mb-8 p-4 bg-gray-50 rounded-lg not-prose';
        container.innerHTML = '<h2 class="toc-title text-lg font-semibold mb-2">Table of Contents</h2>';
        return container;
    }

    function generateTOCContent(headers) {
        const toc = document.createElement('ul');
        toc.className = 'space-y-2';
        
        let sectionCount = 1;
        let subsectionCount = 1;
        let lastLevel = 2; // Start with h2 level

        headers.forEach((header, index) => {
            // Ensure header has an ID
            if (!header.id) {
                header.id = `section-${index}`;
            }

            const level = parseInt(header.tagName.charAt(1));
            const { sectionNumber, newSectionCount, newSubsectionCount, newLastLevel } = 
                generateSectionNumber(level, sectionCount, subsectionCount, lastLevel);

            // Update counters
            sectionCount = newSectionCount;
            subsectionCount = newSubsectionCount;
            lastLevel = newLastLevel;

            // Create TOC item
            const item = createTOCItem(header, level, sectionNumber);
            toc.appendChild(item);

            // Update header in content
            header.prepend(document.createTextNode(sectionNumber));
        });

        return { 
            toc,
            sectionInfo: { sectionCount, subsectionCount, lastLevel }
        };
    }

    function generateSectionNumber(level, sectionCount, subsectionCount, lastLevel) {
        let sectionNumber = '';
        let newSectionCount = sectionCount;
        let newSubsectionCount = subsectionCount;
        let newLastLevel = lastLevel;

        if (level === 2) {
            sectionNumber = `${sectionCount}. `;
            newSubsectionCount = 1;
            newSectionCount++;
            newLastLevel = 2;
        } else if (level === 3) {
            sectionNumber = `${sectionCount - 1}.${subsectionCount}. `;
            newSubsectionCount++;
            newLastLevel = 3;
        }

        return {
            sectionNumber,
            newSectionCount,
            newSubsectionCount,
            newLastLevel
        };
    }

    function createTOCItem(header, level, sectionNumber) {
        const item = document.createElement('li');
        const link = document.createElement('a');
        
        link.href = `#${header.id}`;
        link.textContent = sectionNumber + header.textContent;
        link.className = 'text-gray-700 hover:text-gray-900 hover:underline block';

        // Add indentation based on header level
        const indent = level - 2;
        item.style.paddingLeft = `${indent * 1}rem`;
        item.appendChild(link);

        return item;
    }

    function insertTOC(article, tocContainer) {
        const header = article.querySelector('header');
        if (header) {
            header.parentNode.insertBefore(tocContainer, header.nextSibling);
        } else {
            article.insertBefore(tocContainer, article.firstChild);
        }
    }
</script>
<script>
    const backgrounds = [
        '/img/background/background.png',
        '/img/background/background2.png',
        '/img/background/background3.png'
    ];
    const randomBackground = backgrounds[Math.floor(Math.random() * backgrounds.length)];
    document.body.style.backgroundImage = `url('${randomBackground}')`;
    document.body.style.backgroundRepeat = 'repeat';
</script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        if (!dropdownToggle || !dropdownMenu) {
            console.error('Dropdown elements not found');
            return;
        }

        dropdownToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });

        // Close the dropdown if the user clicks outside of it
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-toggle')) {
                if (dropdownMenu.classList.contains('show')) {
                    dropdownMenu.classList.remove('show');
                }
            }
        });

        // Handle all links in the dropdown menu
        document.querySelectorAll('.dropdown-menu a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                dropdownMenu.classList.remove('show');

                const href = this.getAttribute('href');
                
                // Check if it's an external link or the feed.xml
                if (href.startsWith('http') || href.startsWith('https') || href === '/feed.xml') {
                    window.open(href, '_blank');
                    return;
                }

                // Check if it's the home or archive link
                if (href === '/' || href === '/archive.html') {
                    window.location.href = href;
                    return;
                }

                const isHomePage = window.location.pathname === '/' || window.location.pathname === '/index.html';
                
                if (isHomePage && href.includes('#')) {
                    // If on home page and it's a section link, smooth scroll
                    const targetId = href.split('#')[1];
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth' });
                    }
                } else {
                    // If on another page or it's not a section link, navigate to the page
                    window.location.href = href;
                }
            });
        });
    });

    // Function to scroll to section after page load
    function scrollToSection() {
        const hash = window.location.hash;
        if (hash) {
            const targetElement = document.quefrySelector(hash);
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            }
        }
    }

    // Call scrollToSection after page load
    window.addEventListener('load', scrollToSection);
</script>

</body>
</html>